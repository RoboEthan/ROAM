#include <HardwareSerial.h>

#define MODEM_TX 17
#define MODEM_RX 16
#define APN "wholesale"
#define URL "https://roambot.dev/data"

HardwareSerial modem(2); // use UART2

// Send AT command and optionally wait for substring
String sendAT(const String &cmd, uint32_t timeout = 10000, const char *waitFor = nullptr) {
  modem.println(cmd);
  Serial.println(">> " + cmd);

  String resp;
  uint32_t start = millis();
  while (millis() - start < timeout) {
    while (modem.available()) {
      resp += (char)modem.read();
    }
    if (waitFor && resp.indexOf(waitFor) != -1) break;
    if (resp.indexOf("+HTTPACTION:") != -1) break;
    delay(50);
  }
  Serial.print(resp);
  return resp;
}

// Parse NMEA-style coordinate (e.g., "2801.9200","N") -> 28.0320
float parseCoord(const String &coord, const String &dir) {
  if (coord.length() < 4) return 0.0;
  float deg = coord.substring(0, coord.length() - 7).toFloat();
  float min = coord.substring(coord.length() - 7).toFloat();
  float val = deg + (min / 60.0);
  if (dir == "S" || dir == "W") val = -val;
  return val;
}

bool getGPS(float &lat, float &lon) {
  String resp = sendAT("AT+CGPSINFO", 5000);

  int idx = resp.indexOf("+CGPSINFO:");
  if (idx == -1) return false;

  String data = resp.substring(idx + 10);
  data.trim();
  if (data.startsWith(",")) return false; // no fix

  // Split by commas
  int parts[8];
  String tokens[8];
  int last = 0, count = 0;
  for (int i = 0; i < data.length() && count < 8; i++) {
    if (data[i] == ',' || data[i] == '\n' || data[i] == '\r') {
      tokens[count++] = data.substring(last, i);
      last = i + 1;
    }
  }

  if (count < 4) return false;

  String rawLat = tokens[0];
  String dirLat = tokens[1];
  String rawLon = tokens[2];
  String dirLon = tokens[3];

  lat = parseCoord(rawLat, dirLat);
  lon = parseCoord(rawLon, dirLon);

  return (lat != 0 && lon != 0);
}

void setup() {
  Serial.begin(115200);
  modem.begin(115200, SERIAL_8N1, MODEM_RX, MODEM_TX);
  delay(3000);

  Serial.println("Starting GPS HTTP POST test...");

  // Basic network setup
  sendAT("AT");
  sendAT("AT+CPIN?");
  sendAT("AT+CSQ");
  sendAT("AT+CGATT=1", 10000);
  sendAT("AT+CGDCONT=1,\"IP\",\"" APN "\"");
  sendAT("AT+CGPADDR=1");

  // Turn on GPS
  sendAT("AT+CGPS=1", 5000);

  // Wait for valid GPS fix
  float lat = 0, lon = 0;
  Serial.println("Waiting for GPS fix...");
  for (int i = 0; i < 10 && !getGPS(lat, lon); i++) {
    Serial.print(".");
    delay(3000);
  }
  Serial.println();

  if (lat == 0 && lon == 0) {
    Serial.println("[WARN] No GPS fix yet â€” using default 0,0.");
  } else {
    Serial.printf("[GPS] Got fix: lat=%.6f lon=%.6f\n", lat, lon);
  }

  // Init HTTP
  sendAT("AT+HTTPTERM");
  sendAT("AT+HTTPINIT");
  sendAT("AT+HTTPPARA=\"CID\",1");
  sendAT("AT+HTTPPARA=\"CONTENT\",\"application/json\"");
  sendAT("AT+HTTPPARA=\"URL\",\"" URL "\"");
  sendAT("AT+HTTPSSL=1");

  // Send JSON body with GPS coordinates
  String body = "{\"lat\":" + String(lat, 6) + ",\"lon\":" + String(lon, 6) + "}";
  Serial.println("\n--- Sending: " + body + " ---");

  int len = body.length();
  sendAT("AT+HTTPDATA=" + String(len) + ",10000", 5000, "DOWNLOAD");
  modem.print(body);
  delay(500);

  sendAT("AT+HTTPACTION=1", 15000, "+HTTPACTION");
  sendAT("AT+HTTPREAD", 5000);

  // Cleanup
  sendAT("AT+HTTPTERM");
  sendAT("AT+CGPS=0");
  Serial.println("Done.");
}

void loop() {
  // nothing to do
}
